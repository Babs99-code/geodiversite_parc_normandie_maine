<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="SARR Babacar, NDAO Sokhna Maimouna">

<title>La géodiversité au sein du parc Normandie Maine</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#i.-définition-et-méthodologie" id="toc-i.-définition-et-méthodologie" class="nav-link active" data-scroll-target="#i.-définition-et-méthodologie">I. Définition et méthodologie</a>
  <ul>
  <li><a href="#indice-de-shannon" id="toc-indice-de-shannon" class="nav-link" data-scroll-target="#indice-de-shannon">1. Indice de Shannon</a>
  <ul>
  <li><a href="#formulation" id="toc-formulation" class="nav-link" data-scroll-target="#formulation">1.1 Formulation</a></li>
  <li><a href="#interprétation-de-lindice-de-shannon" id="toc-interprétation-de-lindice-de-shannon" class="nav-link" data-scroll-target="#interprétation-de-lindice-de-shannon">1.2 Interprétation de l’indice de Shannon</a></li>
  </ul></li>
  <li><a href="#strahler" id="toc-strahler" class="nav-link" data-scroll-target="#strahler">2. Strahler</a>
  <ul>
  <li><a href="#principe-de-la-méthode-de-strahler" id="toc-principe-de-la-méthode-de-strahler" class="nav-link" data-scroll-target="#principe-de-la-méthode-de-strahler">2.1 Principe de la méthode de Strahler</a></li>
  <li><a href="#exemple-dapplication-de-lindice-de-strahler-sur-le-cours-deau-du-parc-maine-normandie" id="toc-exemple-dapplication-de-lindice-de-strahler-sur-le-cours-deau-du-parc-maine-normandie" class="nav-link" data-scroll-target="#exemple-dapplication-de-lindice-de-strahler-sur-le-cours-deau-du-parc-maine-normandie">2.2 Exemple d’application de l’indice de Strahler sur le cours d’eau du Parc Maine Normandie</a></li>
  <li><a href="#résultat-de-la-classification" id="toc-résultat-de-la-classification" class="nav-link" data-scroll-target="#résultat-de-la-classification">2.3 Résultat de la classification</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#ii.-étude-de-la-géodiversité-dans-le-parc-régional-maine-normandie" id="toc-ii.-étude-de-la-géodiversité-dans-le-parc-régional-maine-normandie" class="nav-link" data-scroll-target="#ii.-étude-de-la-géodiversité-dans-le-parc-régional-maine-normandie">II. Étude de la géodiversité dans le Parc régional Maine Normandie</a>
  <ul>
  <li><a href="#diversité-géologique" id="toc-diversité-géologique" class="nav-link" data-scroll-target="#diversité-géologique">1. Diversité géologique</a>
  <ul>
  <li><a href="#carte-de-la-diversité-géologique" id="toc-carte-de-la-diversité-géologique" class="nav-link" data-scroll-target="#carte-de-la-diversité-géologique">1.1 Carte de la diversité géologique</a></li>
  </ul></li>
  <li><a href="#diversité-hydrologique" id="toc-diversité-hydrologique" class="nav-link" data-scroll-target="#diversité-hydrologique">2. Diversité hydrologique</a>
  <ul>
  <li><a href="#résultat-de-la-carte-de-la-diversité-hydrologique" id="toc-résultat-de-la-carte-de-la-diversité-hydrologique" class="nav-link" data-scroll-target="#résultat-de-la-carte-de-la-diversité-hydrologique">2.1 Résultat de la carte de la diversité hydrologique</a></li>
  </ul></li>
  <li><a href="#diversité-pédologique" id="toc-diversité-pédologique" class="nav-link" data-scroll-target="#diversité-pédologique">3. Diversité pédologique</a>
  <ul>
  <li><a href="#carte-de-la-diversité-pédologique" id="toc-carte-de-la-diversité-pédologique" class="nav-link" data-scroll-target="#carte-de-la-diversité-pédologique">3.1 Carte de la diversité pédologique</a></li>
  </ul></li>
  <li><a href="#fusion-de-la-géodiversité-du-parc-maine-normandie" id="toc-fusion-de-la-géodiversité-du-parc-maine-normandie" class="nav-link" data-scroll-target="#fusion-de-la-géodiversité-du-parc-maine-normandie">4. Fusion de la géodiversité du Parc Maine Normandie</a>
  <ul>
  <li><a href="#carte-de-la-géodiversité" id="toc-carte-de-la-géodiversité" class="nav-link" data-scroll-target="#carte-de-la-géodiversité">4.1 Carte de la géodiversité</a></li>
  <li><a href="#analyse" id="toc-analyse" class="nav-link" data-scroll-target="#analyse">4.2 Analyse</a></li>
  <li><a href="#limite" id="toc-limite" class="nav-link" data-scroll-target="#limite">4.3 Limite</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">La géodiversité au sein du parc Normandie Maine</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>SARR Babacar, NDAO Sokhna Maimouna </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="i.-définition-et-méthodologie" class="level1">
<h1>I. Définition et méthodologie</h1>
<p>La définition retenue pour la géodiversité est empruntée à Sharples (SHARPLES, 1995) : elle représente l’ensemble des éléments des sous-sols, sols et paysages qui, assemblés les uns aux autres, constituent des systèmes organisés, issus de processus géologiques.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/geodiv.jpg" class="img-fluid figure-img" width="392"></p>
</figure>
</div>
</div>
</div>
<p>Elle comprend :</p>
<p>la diversité géologique : roches, minéraux et fossiles</p>
<p>La diversité géomorphologique : formes du relief et topographie</p>
<p>La diversité pédologique : sols et sédiments</p>
<p>La diversité hydrologique : eaux de surface et souterraines</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Donnees.jpg" class="img-fluid figure-img" width="1629"></p>
</figure>
</div>
</div>
</div>
<section id="indice-de-shannon" class="level2">
<h2 class="anchored" data-anchor-id="indice-de-shannon">1. Indice de Shannon</h2>
<p>L’indice de Shannon, également connu sous le nom d’indice de diversité de Shannon (ou indice de Shannon-Wiener), est une mesure utilisée en écologie pour quantifier la diversité biologique d’un écosystème. Il combine à la fois la richesse spécifique (le nombre total d’espèces présentes) et l’abondance relative de chaque espèce (la proportion d’individus de chaque espèce par rapport à l’ensemble de la communauté). Sa formule prend en compte la probabilité de rencontrer un caractère précis compris dans un ensemble de caractères utilisés.</p>
<section id="formulation" class="level3">
<h3 class="anchored" data-anchor-id="formulation">1.1 Formulation</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Shanon.jpg" class="img-fluid figure-img" width="202"></p>
</figure>
</div>
</div>
</div>
<p>H’ correspond à l’indice de Shannon, selon la formulation suivante : pi = l’abondance proportionnelle ou pourcentage d’abondance d’une espèce présente (pi = ni/N). ni = le nombre d’individus dénombrés pour une espèce présente. N = le nombre total d’individus dénombrés, toute espèce confondue. S = le nombre total ou cardinal de la liste d’espèces présentes.</p>
</section>
<section id="interprétation-de-lindice-de-shannon" class="level3">
<h3 class="anchored" data-anchor-id="interprétation-de-lindice-de-shannon">1.2 Interprétation de l’indice de Shannon</h3>
<p>Plus l’indice est élevé, plus la diversité est grande. Cela signifie qu’il y a un grand nombre d’entités géologiques, hydrologiques et géologique et que l’abondance entre elles dans l’espace de notre parc est assez équilibrée. Un H’ élevé indique des éléments naturels (géologie, pédologie et hydrologie) diversifiés où aucune entité ne domine trop. Plus l’indice est faible, moins la diversité est grande. Cela peut indiquer une situation où une ou quelques éléments dominent largement, tandis que les autres sont peu nombreuses ou absentes. Valeurs possibles : H’ = 0 : Cela signifie qu’il y a seulement un élément naturel présente (pas de diversité). H’ élevé : Cela correspond à un milieu très diversifiée, avec une répartition plus homogène des types d’éléments naturels.</p>
</section>
</section>
<section id="strahler" class="level2">
<h2 class="anchored" data-anchor-id="strahler">2. Strahler</h2>
<p>L’indice de Strahler est une méthode de classification utilisée principalement en hydrologie et en géomorphologie pour caractériser la hiérarchie des cours d’eau dans un bassin versant. Ce système permet de représenter la complexité et la structure du réseau hydrographique.Il s’accompagne souvent de l’indice d’équitabilité de Piélou pour mesurer à quel point ces catégories sont réparties uniformément dans chaque maille de votre grille.</p>
<section id="principe-de-la-méthode-de-strahler" class="level3">
<h3 class="anchored" data-anchor-id="principe-de-la-méthode-de-strahler">2.1 Principe de la méthode de Strahler</h3>
<p>Les segments de tête (sources) sans affluents sont classés comme de premier ordre (ordre 1). Lorsque deux cours d’eau de même ordre se rejoignent, ils forment un cours d’eau d’un ordre supérieur (ordre n+1). Si deux cours d’eau de différents ordres se rejoignent, le cours d’eau résultant conserve l’ordre du cours d’eau le plus élevé.</p>
</section>
<section id="exemple-dapplication-de-lindice-de-strahler-sur-le-cours-deau-du-parc-maine-normandie" class="level3">
<h3 class="anchored" data-anchor-id="exemple-dapplication-de-lindice-de-strahler-sur-le-cours-deau-du-parc-maine-normandie">2.2 Exemple d’application de l’indice de Strahler sur le cours d’eau du Parc Maine Normandie</h3>
<p>A l’aide de Qgis nous avons installé l’extension Arcgeek Calculator qui nous a permit de classer l’ordre des cours d’eau.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Arcgeek_Calculator.png" class="img-fluid figure-img" width="472"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="résultat-de-la-classification" class="level3">
<h3 class="anchored" data-anchor-id="résultat-de-la-classification">2.3 Résultat de la classification</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Strhaler.jpeg" class="img-fluid figure-img" width="1754"></p>
</figure>
</div>
</div>
</div>
<p>Dans le but de garantir une approche comparable à celle adoptée dans la majorité des études existantes, nous avons choisi de créer un indice global de géodiversité. Cet indice a été construit en additionnant les scores de richesse et les indices de Shannon de nos trois sous-indices : géologie, pédologie et hydrologie.</p>
</section>
</section>
</section>
<section id="ii.-étude-de-la-géodiversité-dans-le-parc-régional-maine-normandie" class="level1">
<h1>II. Étude de la géodiversité dans le Parc régional Maine Normandie</h1>
<p>Le parc naturel régional Normandie-Maine est un parc naturel régional (PNR), il couvre 257 214 hectares sur 164 communes de l’Orne, de la Manche, de la Mayenne et de la Sarthe et s’étend ainsi sur deux régions :la Normandie et les Pays de la Loire.</p>
<p>Dans le cadre de notre étude dans ce parc nous allons plus nous intéresser sur sa géodiversité en combinant de la géologie , de la pédologie et de l’hydrologie.</p>
<section id="diversité-géologique" class="level2">
<h2 class="anchored" data-anchor-id="diversité-géologique">1. Diversité géologique</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>my_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sf"</span>, <span class="st">"terra"</span>, <span class="st">"vegan"</span>, <span class="st">"tidyverse"</span>, <span class="st">"ggplot2"</span>,<span class="st">"tmap"</span>,<span class="st">"mapview"</span>,<span class="st">"purrr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Vérifier si les packages sont installés </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>missing_packages <span class="ot">&lt;-</span> my_packages[<span class="sc">!</span>(my_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>])]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Installation des packages manquants depuis le CRAN</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(missing_packages)) <span class="fu">install.packages</span>(missing_packages, </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">repos =</span> <span class="st">"http://cran.us.r-project.org"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Chargement des packages nécessaires</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>geol <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"Data/Geol_parc.shp"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>emprise<span class="ot">&lt;-</span><span class="fu">st_read</span>(<span class="st">"Data/perimetre_2024.shp"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>cellsize <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1000</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>divgeol <span class="ot">&lt;-</span> <span class="cf">function</span>(emprise, cellsize, geol) {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Vérification des inputs</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">inherits</span>(emprise, <span class="st">"sf"</span>), <span class="fu">inherits</span>(geol, <span class="st">"sf"</span>))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Création de la grille</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(<span class="at">x =</span> emprise, <span class="at">cellsize =</span> cellsize) <span class="sc">%&gt;%</span> </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_intersection</span>(emprise) <span class="sc">%&gt;%</span> </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">row_number</span>(), <span class="at">surf =</span> <span class="fu">as.numeric</span>(<span class="fu">st_area</span>(.)))  <span class="co"># ID unique et surface</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filtrer les mailles à l'intérieur de l'emprise</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> grid[<span class="fu">st_contains</span>(emprise, grid)[[<span class="dv">1</span>]], ]</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intersection avec les polygones litho</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  geol_grid <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(geol, grid) <span class="sc">%&gt;%</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">surface_intersection =</span> <span class="fu">as.numeric</span>(<span class="fu">st_area</span>(.)))  <span class="co"># Surface après intersection</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Agrégation par maille et lithologie</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  part_surface_geol <span class="ot">&lt;-</span> geol_grid <span class="sc">%&gt;%</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ID, DESCR) <span class="sc">%&gt;%</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">surface_geol =</span> <span class="fu">sum</span>(surface_intersection), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcul des pourcentages par maille</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  part_geol <span class="ot">&lt;-</span> part_surface_geol <span class="sc">%&gt;%</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">surface_totale =</span> <span class="fu">sum</span>(surface_geol),</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>           <span class="at">part_geol =</span> (surface_geol <span class="sc">/</span> surface_totale) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(ID, DESCR, part_geol) <span class="sc">%&gt;%</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> DESCR, <span class="at">values_from =</span> part_geol, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcul de l'indice de Shannon</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(vegan)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  part_geol<span class="sc">$</span>shannon <span class="ot">&lt;-</span> <span class="fu">diversity</span>(part_geol <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>ID), <span class="at">index =</span> <span class="st">"shannon"</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Jointure des résultats avec la grille</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(part_geol, <span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(grid)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)  <span class="co"># Plan de parallélisation</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>resultsgeol <span class="ot">&lt;-</span> <span class="fu">future_map</span>(</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  cellsize,</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> <span class="fu">divgeol</span>(emprise, <span class="at">cellsize =</span> ., <span class="at">geol =</span> geol),</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(resultsgeol) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"grid_"</span>, cellsize, <span class="st">"m"</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="do">##Cartographie des resultats</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>tmaps <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  resultsgeol,</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> <span class="fu">tm_shape</span>(.x) <span class="sc">+</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_basemap</span>(<span class="st">"Esri.WorldImagery"</span>) <span class="sc">+</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="st">"shannon"</span>,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="st">"quantile"</span>,</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="dv">6</span>,</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">"viridis"</span>,</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Diversité géologique (maille:"</span>, <span class="fu">unique</span>(.x<span class="sc">$</span>cellsize), <span class="st">"m)"</span>)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">legend.outside =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"view"</span>)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>tmaps[[<span class="dv">1</span>]]</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="co">#Export en PNG</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="co">#tmap_save(tmap_arrange(tmaps), filename = "diversite_geologique.png", width = 8, height = 6, dpi = 300)</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Exporter le data frame combiné en CSV</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="co">#write.csv(combined_results, "results_geol.csv", row.names = FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="carte-de-la-diversité-géologique" class="level3">
<h3 class="anchored" data-anchor-id="carte-de-la-diversité-géologique">1.1 Carte de la diversité géologique</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Données1000Géologie.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="diversité-hydrologique" class="level2">
<h2 class="anchored" data-anchor-id="diversité-hydrologique">2. Diversité hydrologique</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(qgisprocess)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Chargement des données</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>plans_eau <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Data/Plan_deau.tif"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>cours_eau <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"Data/Cours_deau2.tif"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>emprise <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/perimetre_2024.shp"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>resolutions <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1000</span>)  <span class="co"># Résolutions pour les grilles</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Fonction principale</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>calcul_hydro <span class="ot">&lt;-</span> <span class="cf">function</span>(plans_eau, cours_eau, emprise, resolutions) {</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  list_cartes <span class="ot">&lt;-</span> <span class="fu">list</span>()  <span class="co"># Pour stocker les cartes</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (res <span class="cf">in</span> resolutions) {</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Création de la grille</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> emprise <span class="sc">%&gt;%</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_make_grid</span>(<span class="at">cellsize =</span> res) <span class="sc">%&gt;%</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id_cell =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_filter</span>(<span class="at">y =</span> emprise, <span class="at">.predicate =</span> st_intersects)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Suppression des mailles touchant les bordures</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> grid[<span class="fu">st_contains</span>(emprise, grid, <span class="at">sparse =</span> <span class="cn">FALSE</span>), ]</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcul des histogrammes zonaux pour cours d'eau</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    path_hist_zonal_cours <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">"hist_zonal_cours_eau_maille_"</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>      res, <span class="st">"m.gpkg"</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    cours_eau_hist_zonal <span class="ot">&lt;-</span> <span class="fu">qgis_run_algorithm</span>(</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">"native:zonalhistogram"</span>,</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">INPUT_RASTER =</span> cours_eau,</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">RASTER_BAND =</span> <span class="dv">1</span>,</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">INPUT_VECTOR =</span> grid,</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">COLUMN_PREFIX =</span> <span class="st">"hist_zonal"</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">OUTPUT =</span> path_hist_zonal_cours</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>()</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcul des histogrammes zonaux pour plans d'eau</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    path_hist_zonal_plans <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>      <span class="st">"hist_zonal_plans_eau_maille_"</span>,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>      res, <span class="st">"m.gpkg"</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    plans_eau_hist_zonal <span class="ot">&lt;-</span> <span class="fu">qgis_run_algorithm</span>(</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>      <span class="st">"native:zonalhistogram"</span>,</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">INPUT_RASTER =</span> plans_eau,</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">RASTER_BAND =</span> <span class="dv">1</span>,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">INPUT_VECTOR =</span> grid,</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">COLUMN_PREFIX =</span> <span class="st">"hist_zonal"</span>,</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">OUTPUT =</span> path_hist_zonal_plans</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>()</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fusion des données et calcul des indices</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    Hydro_def <span class="ot">&lt;-</span> <span class="fu">st_drop_geometry</span>(cours_eau_hist_zonal) <span class="sc">%&gt;%</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">st_drop_geometry</span>(plans_eau_hist_zonal), <span class="at">by =</span> <span class="st">"id_cell"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"hist_zonalNODATA"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate_all</span>(<span class="sc">~</span> <span class="fu">replace_na</span>(., <span class="dv">0</span>))</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    tableau_final <span class="ot">&lt;-</span> Hydro_def <span class="sc">%&gt;%</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id_cell) <span class="sc">%&gt;%</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">S =</span> <span class="fu">specnumber</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"hist_zonal"</span>))),</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">shannon =</span> <span class="fu">diversity</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"hist_zonal"</span>))),</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">pielou =</span> shannon <span class="sc">/</span> <span class="fu">log</span>(S)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Création de la carte</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    tableau_final_sf <span class="ot">&lt;-</span> <span class="fu">left_join</span>(tableau_final, grid, <span class="at">by =</span> <span class="st">"id_cell"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>()</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(emprise) <span class="sc">+</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_shape</span>(tableau_final_sf) <span class="sc">+</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_polygons</span>(<span class="st">"shannon"</span>, <span class="at">style =</span> <span class="st">"order"</span>, <span class="at">n =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_layout</span>(</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="dv">0</span>),</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.frame =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title.fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.outside.size =</span> <span class="fl">0.22</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"bottom"</span>), <span class="at">text.size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>))</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export de la carte en PNG</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    titre_carte <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Diversité"</span>,</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>      res, <span class="st">"_hydrologie.png"</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tmap_save</span>(map, <span class="at">filename =</span> titre_carte, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">600</span>)</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">#list_cartes[[as.character(res)]] &lt;- map</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export des données en CSV</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>   <span class="co"># resultat_final_hydro &lt;- "C:/Users/mamba/Desktop/L.Pro SIG-DAT/SIG et Analyse spatiale/TPE/Projet_Ecotone_GeoDiv/Données/csv_hydrologie.csv"</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  write.csv(tableau_final_sf, file = resultat_final_hydro, row.names = FALSE)</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Affichage des cartes</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(tmap_arrange(list_cartes, nrow = 2))</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="résultat-de-la-carte-de-la-diversité-hydrologique" class="level3">
<h3 class="anchored" data-anchor-id="résultat-de-la-carte-de-la-diversité-hydrologique">2.1 Résultat de la carte de la diversité hydrologique</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Données1000hydrologie.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="diversité-pédologique" class="level2">
<h2 class="anchored" data-anchor-id="diversité-pédologique">3. Diversité pédologique</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapsf)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(questionr)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="do">##ajout de couche shp(zone d'etude et pedologie)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>perimetre_2024 <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/perimetre_2024.shp"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>sol_normand <span class="ot">&lt;-</span><span class="fu">st_read</span>(<span class="st">"Data/Pedologie_PMN.shp"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="do">##emprise et des resolutions</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>emprise <span class="ot">=</span> perimetre_2024</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>resolutions <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1000</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>list_pedologie <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="do">##calcul de la diversite </span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>calcul_diversite <span class="ot">&lt;-</span> <span class="cf">function</span>(sol_maine, emprise, resolutions)  <span class="do">## définition du fonction qui comprend 3 arguments </span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  list_pedologie <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (calcul_diversite <span class="cf">in</span> list_pedologie){</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="do">##creation de la grille qui intersecte la zone emprise </span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>grille <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(emprise, <span class="at">cellsize =</span> <span class="dv">1000</span>, <span class="at">square =</span> <span class="cn">TRUE</span>) </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>grille <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> grille)   <span class="do">## conversion de la grille en sf</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="do">##découpage grille </span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>grille <span class="ot">&lt;-</span> grille <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">id_cell =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))   <span class="do">## ajout d'un identifiant id_cell qui contient les valeurs de la cellule totale </span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filtrer les mailles à l'intérieur de l'emprise</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  grille <span class="ot">&lt;-</span> grille[<span class="fu">st_contains</span>(emprise, grille)[[<span class="dv">1</span>]], ] <span class="co"># filtrer les cellules de la grille qui intersectent l'emprise </span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="do">## calcul de la surface de sol dans chaque maille</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>surface_sol <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(grille, sol_normand) <span class="sc">%&gt;%</span>  <span class="do">## creer une intersection entre la grille et la couche pedologique</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">area =</span> <span class="fu">st_area</span>(.)) <span class="sc">%&gt;%</span>    <span class="do">##Calcule l'aire de chaque intersection.</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span>             <span class="do">##</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_cell, nom_type) <span class="sc">%&gt;%</span> </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">surface =</span> <span class="fu">sum</span>(area)) <span class="sc">%&gt;%</span> </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">as.double</span>(surface), <span class="at">nom_type =</span> <span class="fu">as.character</span>(nom_type))</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="do">##calcul d=indice de shanon</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>indice_shanon <span class="ot">&lt;-</span> surface_sol <span class="sc">%&gt;%</span> </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_cell) <span class="sc">%&gt;%</span> </span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">S =</span> <span class="fu">n_distinct</span>(nom_type),</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">shannon =</span> <span class="fu">diversity</span>(surface),</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">pielou=</span> <span class="fu">diversity</span>(surface)<span class="sc">/</span><span class="fu">log</span>(S))</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="do">##tableau final </span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>tableau_final <span class="ot">&lt;-</span> indice_shanon <span class="sc">%&gt;%</span> </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_cell) <span class="sc">%&gt;%</span> </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">S =</span> <span class="fu">first</span>(S), </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>             <span class="at">shannon =</span> <span class="fu">first</span>(shannon),</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>             <span class="at">pielou =</span> <span class="fu">first</span>(pielou)) <span class="sc">%&gt;%</span> </span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>              <span class="fu">left_join</span>(., grille, <span class="at">by=</span><span class="st">"id_cell"</span>)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>tableau_final_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(tableau_final)</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(emprise) <span class="sc">+</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(tableau_final_sf) <span class="sc">+</span> </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">"shannon"</span>, <span class="at">style=</span><span class="st">"order"</span>, <span class="at">n=</span><span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.outside =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="dv">0</span>), </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.frame =</span> <span class="cn">FALSE</span>,                     </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.title.fontface =</span> <span class="st">"bold"</span>, </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside.size =</span> <span class="fl">0.22</span>) <span class="sc">+</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">position=</span><span class="fu">c</span>(<span class="st">"left"</span>,<span class="st">"bottom"</span>), <span class="at">text.size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">position=</span> <span class="fu">c</span>(<span class="st">"right"</span>,<span class="st">"top"</span>))</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="do">## carte </span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="co">#tmap_mode("plot")</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="co">#tm_shape(emprise) + tm_polygons() + </span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>          <span class="co"># tm_shape(tableau_final_sf) + #tm_polygons("shannon", style = "order", n = 5)</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="co">#Export png</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="co">#titre_carte &lt;- paste("C:/Users/mamba/Desktop/L.Pro SIG-DAT/SIG et Analyse spatiale/TPE/Projet_Ecotone_GeoDiv/Données",</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                   resolutions, "pédologie1000PMN.png", sep = "")</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="co">#tmap_save(map, filename = titre_carte, width = 8, height = 6, dpi = 600)</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="co">#list_cartes[[as.character(res)]] &lt;- map</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="do">## export csv tableau fin</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a><span class="co">#resultat_final_pedo &lt;- paste("C:/Users/mamba/Desktop/L.Pro SIG-DAT/SIG et Analyse spatiale/TPE/Projet_Ecotone_GeoDiv/Données/csv_pedologie.csv")</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="co">#resultat_final &lt;- write.csv(tableau_final_sf, file = resultat_final_pedo)</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="carte-de-la-diversité-pédologique" class="level3">
<h3 class="anchored" data-anchor-id="carte-de-la-diversité-pédologique">3.1 Carte de la diversité pédologique</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Données1000pédologie1000PMN.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="fusion-de-la-géodiversité-du-parc-maine-normandie" class="level2">
<h2 class="anchored" data-anchor-id="fusion-de-la-géodiversité-du-parc-maine-normandie">4. Fusion de la géodiversité du Parc Maine Normandie</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Packages nécessaires</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>my_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sf"</span>, <span class="st">"terra"</span>, <span class="st">"vegan"</span>, <span class="st">"tidyverse"</span>, <span class="st">"ggplot2"</span>, <span class="st">"tmap"</span>, <span class="st">"mapview"</span>, <span class="st">"data.table"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérification et installation des packages manquants</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>missing_packages <span class="ot">&lt;-</span> my_packages[<span class="sc">!</span>(my_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[, <span class="st">"Package"</span>])]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(missing_packages)) <span class="fu">install.packages</span>(missing_packages, <span class="at">repos =</span> <span class="st">"http://cran.us.r-project.org"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Chargement des packages</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(my_packages, library, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)  <span class="co"># Pour éviter les conflits avec `select()`</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Résolutions pour la grille</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>resolutions <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1000</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Boucle sur chaque résolution</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (res <span class="cf">in</span> resolutions) {</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Chargement des fichiers CSV</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  hydro <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"csv/hydrologie.csv"</span>, <span class="at">sep =</span> <span class="st">";"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  geol <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"csv/geologie.csv"</span>, <span class="at">sep =</span> <span class="st">";"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  pedo <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"csv/pedologie.csv"</span>, <span class="at">sep =</span> <span class="st">";"</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fusionner les DataFrames sur `id_cell`</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  combined_df <span class="ot">&lt;-</span> hydro <span class="sc">%&gt;%</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(geol, <span class="at">by =</span> <span class="st">"id_cell"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(pedo, <span class="at">by =</span> <span class="st">"id_cell"</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcul des indices de diversité</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  geodiv <span class="ot">&lt;-</span> combined_df <span class="sc">%&gt;%</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculer Geodiv.S en ignorant la pédologie si manquante</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">Geodiv.S =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Pedo.S), Hydro.S <span class="sc">+</span> Geol.S, Hydro.S <span class="sc">+</span> Geol.S <span class="sc">+</span> Pedo.S),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculer Geodiv.shannon en ignorant la pédologie si manquante</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">Geodiv.shannon =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Pedo.shannon), Hydro.shannon <span class="sc">+</span> Geol.shannon, Hydro.shannon <span class="sc">+</span> Geol.shannon <span class="sc">+</span> Pedo.shannon),</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculer Geodiv.pielou en ignorant la pédologie si manquante</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">Geodiv.pielou =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Pedo.pielou), Hydro.pielou <span class="sc">+</span> Geol.pielou, Hydro.pielou <span class="sc">+</span> Geol.pielou <span class="sc">+</span> Pedo.pielou)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(id_cell, Geodiv.S, Geodiv.shannon, Geodiv.pielou)  <span class="co"># 🔹 Correction ici</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Chargement de l'emprise</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  emprise <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/perimetre_2024.shp"</span>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Création de la grille</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> emprise <span class="sc">%&gt;%</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_make_grid</span>(<span class="at">cellsize =</span> res) <span class="sc">%&gt;%</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id_cell =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_filter</span>(emprise, <span class="at">.predicate =</span> st_intersects)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filtrer les mailles à l'intérieur de l'emprise</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> grid[<span class="fu">st_contains</span>(emprise, grid)[[<span class="dv">1</span>]], ]</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Conversion en sf</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  geodiv_sf <span class="ot">&lt;-</span> geodiv <span class="sc">%&gt;%</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(., grid, <span class="at">by =</span> <span class="st">"id_cell"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>()</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Colonnes à visualiser</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  columns_to_map <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Geodiv.S"</span>, <span class="st">"Geodiv.shannon"</span>, <span class="st">"Geodiv.pielou"</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Génération des cartes</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col <span class="cf">in</span> columns_to_map) {</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(emprise) <span class="sc">+</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_shape</span>(geodiv_sf) <span class="sc">+</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_polygons</span>(col, <span class="at">style =</span> <span class="st">"order"</span>, <span class="at">n =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_layout</span>(</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="dv">0</span>),</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.frame =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title.fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.outside.size =</span> <span class="fl">0.22</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"bottom"</span>), <span class="at">text.size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>))</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exportation des cartes</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    titre_carte <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Géodiversité"</span>,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>                          col, <span class="st">"_maille_"</span>, res, <span class="st">"m_parc_maine_normandie.png"</span>)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tmap_save</span>(map, <span class="at">filename =</span> titre_carte, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">600</span>)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="carte-de-la-géodiversité" class="level3">
<h3 class="anchored" data-anchor-id="carte-de-la-géodiversité">4.1 Carte de la géodiversité</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Geodiv.shannon_maille_1000m_parc_maine_normandie.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/Fusion%20géodiv.png" class="img-fluid figure-img" width="558"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="analyse" class="level3">
<h3 class="anchored" data-anchor-id="analyse">4.2 Analyse</h3>
<p>La géodiversité du Parc Naturel Régional Normandie-Maine est marquée par une forte hétérogénéité spatiale résultant de la combinaison des composantes géologiques, pédologiques et hydrologiques. L’indice de Shannon appliqué à la géodiversité révèle des valeurs élevées principalement dans le nord et l’est du parc, suggérant une richesse en formations géologiques variées, probablement associées à une alternance entre substrats anciens et formations sédimentaires plus récentes. Cette diversité géologique influence directement la diversité pédologique, bien que l’absence de données sur les sols dans la partie sud constitue une limite importante à l’analyse. L’hydrologie joue également un rôle clé, avec la présence de cours d’eau et de zones humides qui façonnent l’érosion et la composition des sols, contribuant ainsi à la variabilité des conditions environnementales.</p>
</section>
<section id="limite" class="level3">
<h3 class="anchored" data-anchor-id="limite">4.3 Limite</h3>
<p>La géodiversité du Parc Naturel Régional Normandie-Maine présente une structuration spatiale marquée par une diversité géologique élevée dans le nord et l’est du territoire,en raison de la présence de formations variées incluant des substrats anciens et des couches sédimentaires plus récentes. Cette diversité géologique influe directement sur la diversité pédologique et hydrologique, façonnant ainsi la répartition de l’indice de Shannon. Toutefois, une limite majeure de cette analyse réside dans l’absence de données pédologiques dans la partie sud du parc, ce qui introduit un biais significatif dans l’interprétation des résultats. En effet, sans ces informations, il est impossible de déterminer si cette zone présente une faible géodiversité réelle ou si elle aurait des valeurs comparables à celles observées dans le reste du parc. Cette lacune empêche également d’établir des corrélations précises entre la diversité géologique et les dynamiques pédologiques, ce qui réduit la portée des conclusions sur l’interaction entre ces composantes. De plus, cette absence de données crée une rupture visuelle nette sur la carte, qui pourrait être mal interprétée comme une zone homogène ou dépourvue d’intérêt, alors qu’elle pourrait en réalité contenir des éléments de géodiversité notables.</p>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>En conclusion, l’analyse de la géodiversité au sein du Parc Naturel Régional Normandie-Maine met en évidence une forte hétérogénéité spatiale, influencée par la diversité des formations géologiques, pédologiques et hydrologiques. L’indice de Shannon appliqué à cette étude permet de révéler des zones de forte géodiversité, principalement concentrées dans le nord et l’est du territoire, là où les interactions entre substrats anciens, types de sols variés et dynamiques hydrologiques sont les plus marquées. Toutefois, l’interprétation de ces résultats est limitée par l’absence de données pédologiques dans la partie sud du parc, ce qui biaise l’analyse et empêche une vision complète du territoire. Cette lacune souligne la nécessité de compléter les informations disponibles pour affiner la compréhension des relations entre les composantes de la géodiversité. Malgré ces limites, cette étude offre une première approche cartographique précieuse pour la gestion et la conservation des milieux naturels du parc, mettant en lumière les zones à forte diversité qui méritent une attention particulière. Pour une analyse plus exhaustive, l’intégration de nouvelles données et une approche multi-échelle permettraient d’affiner les résultats et de mieux appréhender les interactions complexes entre géologie, pédologie et hydrologie.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>